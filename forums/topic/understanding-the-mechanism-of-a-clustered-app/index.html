<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

	<title>Understanding the mechanism of a clustered app</title>
	<meta name="description" content="Express.js discussion forums" />
	<meta name="keywords" content="express, express.js, book, forum, forums, nodejs, node.js" />
<link rel="stylesheet" type="text/css" href="../../../wp-content/themes/ewad/style.css"></style>
<script type="text/javascript" src="../../../wp-content/themes/ewad/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="../../../wp-content/themes/ewad/main.js"></script>
<link rel='stylesheet' id='bbp-default-css'  href='../../../wp-content/plugins/bbpress/templates/default/css/bbpress.css%3Fver=2.5.4-5380.css' type='text/css' media='screen' />
<script type='text/javascript' src='http://expressjs-book.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://expressjs-book.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://expressjs-book.com/wp-includes/wlwmanifest.xml" /> 
<link rel='next' title='Confirmed Errata' href='../../../index.html%3Fp=27.html' />

<link rel='shortlink' href='../../../index.html%3Fp=74.html' />
	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>

<!-- All in One SEO Pack 2.2.2 by Michael Torbert of Semper Fi Web Design[144,178] -->
<meta name="description"  content="This post is based on a query by one of my readers regarding the example of a clustered app in the book. var cluster = require('cluster'); // Master" />

<link rel="canonical" href="../../../index.html%3Fp=74.html" />
<!-- /all in one seo pack -->
</head>
<body>
<div id="toolbar">
	<ul>
		<li><a href="../../../index.html">HOME</a></li>
		<li id="discussion"><a href="../../../forums.html"class="active">DISCUSSION</a></li>
		<li id="join-us"></li>
				<li id="signup"><a href="../../../wp-login.php%3Faction=register.html">Register</a></li>
		<li id="login"><a href="../../../wp-login.php%3Fredirect_to=http%253A%252F%252Fexpressjs-book.com%252Fforums%252Ftopic%252Funderstanding-the-mechanism-of-a-clustered-app%252F.html">Log In</a></li>
			</ul>
</div>

<div id="wrapper">

	
					<div id="forum">
					
<div id="bbpress-forums">

	<div class="bbp-breadcrumb"><p><a href="../../../index.html" class="bbp-breadcrumb-home">Home</a> <span class="bbp-breadcrumb-sep">&rsaquo;</span> <a href="../../../forums.html" class="bbp-breadcrumb-root">Forums</a> <span class="bbp-breadcrumb-sep">&rsaquo;</span> <a href="../../../index.html%3Fp=20.html" class="bbp-breadcrumb-forum">Chapter 8: Express in Production</a> <span class="bbp-breadcrumb-sep">&rsaquo;</span> <span class="bbp-breadcrumb-current">Understanding the mechanism of a clustered app</span></p></div>
	
	
		
		<div class="bbp-template-notice info"><p class="bbp-topic-description">This topic contains 0 replies, has 1 voice, and was last updated by <a href="../../users/captain/index.html" title="View Yaapa&#039;s profile" class="bbp-author-avatar" rel="nofollow"><img alt='' src='http://0.gravatar.com/avatar/ac96905ca7b25f0577e4bcc9c344afb6?s=14&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D14&amp;r=G' class='avatar avatar-14 photo' height='14' width='14' /></a>&nbsp;<a href="../../users/captain/index.html" title="View Yaapa&#039;s profile" class="bbp-author-name" rel="nofollow">Yaapa</a> <a href="../../../index.html%3Fp=74.html" title="Understanding the mechanism of a clustered app">1 year, 8 months ago</a>.</p></div>
		
		
			

<div class="bbp-pagination">
	<div class="bbp-pagination-count">

		Viewing 1 post (of 1 total)
	</div>

	<div class="bbp-pagination-links">

		
	</div>
</div>


			

<ul id="topic-74-replies" class="forums bbp-replies">

	<li class="bbp-header">

		<div class="bbp-reply-author">Author</div><!-- .bbp-reply-author -->

		<div class="bbp-reply-content">

			
				Posts
				
				
			
		</div><!-- .bbp-reply-content -->

	</li><!-- .bbp-header -->

	<li class="bbp-body">

		
			
				
<div id="post-74" class="bbp-reply-header">

	<div class="bbp-meta">

		<span class="bbp-reply-post-date">August 24, 2013 at 7:36 pm</span>

		
		<a href="../../../index.html%3Fp=74.html#post-74" class="bbp-reply-permalink">#74</a>

		
		<span class="bbp-admin-links"></span>
		
	</div><!-- .bbp-meta -->

</div><!-- #post-74 -->

<div class="post-74 topic type-topic status-publish hentry odd bbp-parent-forum-20 bbp-parent-topic-74 bbp-reply-position-1 user-id-2 topic-author">

	<div class="bbp-reply-author">

		
		<a href="../../users/captain/index.html" title="View Yaapa&#039;s profile" class="bbp-author-avatar" rel="nofollow"><img alt='' src='http://0.gravatar.com/avatar/ac96905ca7b25f0577e4bcc9c344afb6?s=80&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D80&amp;r=G' class='avatar avatar-80 photo' height='80' width='80' /></a><br /><a href="../../users/captain/index.html" title="View Yaapa&#039;s profile" class="bbp-author-name" rel="nofollow">Yaapa</a><br /><div class="bbp-author-role">Keymaster</div>
		
		
	</div><!-- .bbp-reply-author -->

	<div class="bbp-reply-content">

		
		<p>This post is based on a query by one of my readers regarding the example of a clustered app in the book.</p>
<pre class="block">
var cluster = require('cluster');

// Master process - starts the workers
if (cluster.isMaster) {

  // Create a worker process for each core
  require('os').cpus().forEach(function() {

    // Start a worker process
    cluster.fork();

  });

  // In case a worker dies, a new one should be started
  cluster.on('exit', function (worker, code, signal) {
    cluster.fork();
  });

}
// Code for the worker processes to execute
else {

  var worker_id = 'Worker' + cluster.worker.id;

  var http = require('http');
  var express = require('express');
  var app = express();

  app.get('/', function (req, res) {

    // An resource-intensive operation
    var a = [];
    for (var i = 0; i < 100000; i++) { a.push(i); }
      
    // A large chunk of data
    res.send(a.toString());
  });

  // Start the app
  http.createServer(app).listen(3000, function() {
    console.log('Express app started by %s', worker_id);
  });

}
</pre>
<p>One might wonder if the code above could be 'optimized' in the following manner.</p>
<pre class="block">
var cluster = require('cluster');

var http = require('http');
var express = require('express');
var app = express();

app.get('/', function (req, res) {
  ...
});

// Master process - starts the workers
if (cluster.isMaster) {
  ...
}
// Code for the worker processes to execute
else {

  var worker_id = 'Worker' + cluster.worker.id;

  // Start the app
  http.createServer(app).listen(3000, function() {
    console.log('Express app started by %s', worker_id);
  });

}
</pre>
<p>The idea behind the 'optimization' comes from the intention of sharing one Express instance between the workers, instead of creating multiple instances of Express. Will it work? Is it a good idea? </p>
<p>The following information will help you understand why the 'optimization' introduces redundancy, instead of actually optimizing the code.</p>
<p>When you cluster an app, the script is executed (NUMBER_OF_FORKS + 1) times - and they all will be executing as separate processes with no references of objects created in any of the instances. Think of it like you are manually doing <code>$ node app</code>, except they will all magically listen on the same port number without any conflict.</p>
<p>Hence, putting the initialization code outside the <code>if</code> construct does not help in optimizing the code or performance, because the app instances will not be shared by the forks. Rather you add redundant initialization objects even to the master process, which it does not need.</p>

		
	</div><!-- .bbp-reply-content -->

</div><!-- .reply -->

			
		
	</li><!-- .bbp-body -->

	<li class="bbp-footer">

		<div class="bbp-reply-author">Author</div>

		<div class="bbp-reply-content">

			
				Posts
			
		</div><!-- .bbp-reply-content -->

	</li><!-- .bbp-footer -->

</ul><!-- #topic-74-replies -->


			

<div class="bbp-pagination">
	<div class="bbp-pagination-count">

		Viewing 1 post (of 1 total)
	</div>

	<div class="bbp-pagination-links">

		
	</div>
</div>


		
		<div id="advts-block" style="width: 728px; margin: 0 auto 20px">
	<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- EWAD-LB0 -->
	<ins class="adsbygoogle"
	     style="display:inline-block;width:728px;height:90px"
	     data-ad-client="ca-pub-0762366973631369"
	     data-ad-slot="9857477349"></ins>
	<script>
	(adsbygoogle = window.adsbygoogle || []).push({});
	</script>
</div>




	<div id="no-reply-74" class="bbp-no-reply">
		<div class="bbp-template-notice">
			<p>You must be logged in to reply to this topic.</p>
		</div>
	</div>



	
	
</div>
			</div>
		
	
				<div id="footer">
			Copyright &copy; 2015 <a rel="author" href="https://plus.google.com/103752924219473791252" target="_blank" title="Google +">Hage Yaapa</a>
			<div id="twitter"><a href="https://twitter.com/hacksparrow">@hacksparrow <img src="../../../wp-content/themes/ewad/twitter.png" /></a></div>
			</div>

			<script type='text/javascript' src='../../../wp-content/plugins/bbpress/templates/default/js/editor.js%3Fver=2.5.4-5380'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var bbpTopicJS = {"bbp_ajaxurl":"http:\/\/expressjs-book.com\/forums\/topic\/understanding-the-mechanism-of-a-clustered-app\/?bbp-ajax=true","generic_ajax_error":"Something went wrong. Refresh your browser and try again.","is_user_logged_in":"","fav_nonce":"6b2f9539b2","subs_nonce":"6bbff07aa3"};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/plugins/bbpress/templates/default/js/topic.js%3Fver=2.5.4-5380'></script>
		</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42449377-1', 'expressjs-book.com');
  ga('send', 'pageview');

</script>

	</body>
</html>